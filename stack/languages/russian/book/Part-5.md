## Часть 5

[![](https://rawgit.com/Bogdan-Lyashenko/Under-the-hood-ReactJS/master/stack/images/5/part-5.svg)](https://rawgit.com/Bogdan-Lyashenko/Under-the-hood-ReactJS/master/stack/images/5/part-5.svg)

<em>5.0 Часть 5 (кликабельно)</em>

### Обновление DOM-свойств

Выглядит страшновато, да? Основная идея тут - эффективно применить разницу между предыдущими и новыми `props`. Взгляните на комментарий к методу в коде:
> "Выполняет согласование (реконсиляцию) свойств путем обнаружения разницы в их значениях и обновляя DOM по необходимости. Эта функция вероятно наиважнейший критический путь при оптимизации производительности."

На самом деле здесь два цикла - сначала по предыдущим `props` и затем по следующий `props`. В нашем случае с монтированием компонента `lastProps` (предыдущие) - пусты (ведь это первый раз когда мы их назначаем) - но все равно, давайте посмотрим, что там происходит.

### Цикл по предыдущим `props`
Первым шагом проверяем, есть ли такое же свойство в `nextProps` - если есть, то пока пропускаем, потому что мы его обработаем попозже в цикле `nextProps`.
Затем мы сбрасываем значения в style, удаляем обработчики событий (если они выставлялись) и убираем DOM-атрибуты и значения DOM-свойств. Для атрибутов проверяем, что они не относятся к списку `RESERVED_PROPS`, которые на самом деле являются свойствами, например `children` или `dangerouslySetInnerHTML`.

### Цикл по новым `props`
Здесь мы первым делом смотрим, поменялся ли `prop`, то есть отличается ли его новое значение от предыдущего. Если нет, то ничего не делаем. Для `styles` (вы вероятно заметили, что оно обрабатываемся немного по-особому) мы обновляем значения, который поменялись с последнего `lastProps`. Затем мы добавляем обработчики событий (как раз те, которые `onClick` и прочие). Давайте тут детально посмотрим.

Важным моментом тут является то, что в React-приложения все действия выполняются через именованные синтетические (`synthethic`) события. В принципе, ничего особого - просто еще пара оберток для более эффективной работы. Далее, модуль-посредник [EventPluginHub](https://github.com/facebook/react/blob/v15.4.2/src/renderers/shared/stack/event/EventPluginHub.js) для управления обработчиками событий. Он содержит словарь `listenerBank` для кэширования и управления всеми обработчиками.
Чуть попозже мы посмотрим, как добавляются наши собственные обработчики событий, а пока просто возьмем на заметку, что обработчики событий добавляются, когда компонент и DOM-элемент готовы работать с событиями, а значит у нас тут отложенное исполнение. Закономерно возникает вопрос, а как же нам узнать момент, когда это случится? И сейчас мы дадим ответ: помните, как мы передавали `transaction` через все методы и вызовы? Вот тут-то это и пригодилось, именно для таких ситуаций оно и нужно. Код это подтверждает:

```javascript
//src\renderers\dom\shared\ReactDOMComponent.js#222
transaction.getReactMountReady().enqueue(putListener, {
    inst: inst,
    registrationName: registrationName,
    listener: listener,
});
```
https://github.com/facebook/react/blob/v15.4.2/src/renderers/dom/shared/ReactDOMComponent.js#L222

Хорошо, после обработчиков событий мы выставляем DOM-атрибуты и значения DOM-свойствам. Так же как и в первом цикле, для атрибутов мы проверяем, что они не относятся к списку `RESERVED_PROPS`, которые на самом деле являются свойствами, например `children` или `dangerouslySetInnerHTML`.

Во время обработки предыдущих и новых свойств, мы собираем `styleUpdates` и передаем его в модуль `CSSPropertyOperations`.

Вот и все, обновление свойств мы рассмотрели.

### Хорошо, *Часть 5* мы закончили.

Давайте вспомним, как мы сюда попали - глянем еще раз на схему, затем уберем из нее избыточные и менее важные куски, и она станет вот такой:

[![](https://rawgit.com/Bogdan-Lyashenko/Under-the-hood-ReactJS/master/stack/images/5/part-5-A.svg)](https://rawgit.com/Bogdan-Lyashenko/Under-the-hood-ReactJS/master/stack/images/5/part-5-A.svg)

<em>5.1 Часть 5 упрощенно (кликабельно)</em>

Уберем пустое место и поправим выравнивание:

[![](https://rawgit.com/Bogdan-Lyashenko/Under-the-hood-ReactJS/master/stack/images/5/part-5-B.svg)](https://rawgit.com/Bogdan-Lyashenko/Under-the-hood-ReactJS/master/stack/images/5/part-5-B.svg)

<em>5.2 Часит 5 упрощенно и с рефакторингом (cliкликабельноckable)</em>

Вот теперь отлично. По сути, это все что происходит на этой стадии. Поэтому мы возьмем эту ключевую выдержку из *Части 5* и поместим ее на итоговую схему процесса `монтирования`:

[![](https://rawgit.com/Bogdan-Lyashenko/Under-the-hood-ReactJS/master/stack/images/5/part-5-C.svg)](https://rawgit.com/Bogdan-Lyashenko/Under-the-hood-ReactJS/master/stack/images/5/part-5-C.svg)

<em>5.3 Часть 5 ключевые моменты (кликабельно)</em>

И мы закончили!


[На следующую страницу: Часть 6 >>](./Part-6.md)

[<< На предыдущую страницу: Часть 4](./Part-4.md)


[К оглавлению](../../README.md)
